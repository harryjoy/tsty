"use strict";
var fs = require("fs");
var path = require("path");
var Promise = require("bluebird");
var StaticLogger_1 = require("../../components/logs/StaticLogger");
var ModulesLoader = (function () {
    function ModulesLoader(packageJson, moduleNameInPackageJson, moduleAppFileNameInPackageJson, moduleDependenciesInPackageJson) {
        this.packageJson = packageJson;
        this.moduleNameInPackageJson = moduleNameInPackageJson;
        this.moduleAppFileNameInPackageJson = moduleAppFileNameInPackageJson;
        this.moduleDependenciesInPackageJson = moduleDependenciesInPackageJson;
    }
    ModulesLoader.prototype.loadModule = function (list, disabledModules, moduleBase) {
        var deferred = Promise.defer();
        fs.readdir(path.join(process.cwd(), moduleBase), this.processDirs.bind(this, list, disabledModules, moduleBase, deferred));
        return deferred.promise;
    };
    ModulesLoader.prototype.processDirs = function (list, disabledModules, moduleBase, deferred, error, files) {
        var _this = this;
        if (!error && files && files.length > 0) {
            for (var i in disabledModules) {
                var index = files.indexOf(i);
                if (index < 0) {
                    continue;
                }
                files.splice(index, 1);
            }
            var promises_1 = [];
            files.forEach(function (file) {
                var deferred = Promise.defer();
                fs.readFile(path.join(process.cwd(), moduleBase, file, _this.packageJson), _this.processPacakgeJsonFile.bind(_this, list, moduleBase, file, deferred));
                promises_1.push(deferred.promise);
            });
            Promise.all(promises_1).then(function () {
                return deferred.resolve();
            });
        }
        else {
            if (error && error.code !== "ENOENT") {
                StaticLogger_1.default.error(error);
                return deferred.reject(error);
            }
            return deferred.resolve();
        }
    };
    ModulesLoader.prototype.processPacakgeJsonFile = function (list, moduleBase, file, deferred, error, fileData) {
        if (error || !fileData) {
            return deferred.resolve();
        }
        try {
            var data = JSON.parse(fileData);
            if (data[this.moduleNameInPackageJson]) {
                var moduleAppFile = data[this.moduleAppFileNameInPackageJson];
                var dependantModule = list.createModule(data.name, data.version, path.join(moduleBase, file), moduleAppFile);
                var dependencies = data[this.moduleDependenciesInPackageJson];
                if (dependencies) {
                    dependantModule.cloneDependencies(dependencies);
                }
                list.add(dependantModule);
            }
        }
        catch (err) {
            StaticLogger_1.default.error(err);
            return deferred.reject(err);
        }
        return deferred.resolve();
    };
    return ModulesLoader;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = ModulesLoader;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9tb2R1bGUvTW9kdWxlc0xvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsSUFBWSxFQUFFLFdBQU0sSUFBSSxDQUFDLENBQUE7QUFDekIsSUFBWSxJQUFJLFdBQU0sTUFBTSxDQUFDLENBQUE7QUFDN0IsSUFBWSxPQUFPLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFJcEMsNkJBQXlCLG9DQUFvQyxDQUFDLENBQUE7QUFFOUQ7SUFDSSx1QkFBb0IsV0FBbUIsRUFBVSx1QkFBK0IsRUFDcEUsOEJBQXNDLEVBQ3RDLCtCQUF1QztRQUYvQixnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUFVLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBUTtRQUNwRSxtQ0FBOEIsR0FBOUIsOEJBQThCLENBQVE7UUFDdEMsb0NBQStCLEdBQS9CLCtCQUErQixDQUFRO0lBQUcsQ0FBQztJQUV2RCxrQ0FBVSxHQUFWLFVBQVcsSUFBZ0IsRUFBRSxlQUE4QixFQUFFLFVBQWtCO1FBQzNFLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNqQyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLFVBQVUsQ0FBQyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFFLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzNILE1BQU0sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO0lBQzVCLENBQUM7SUFFTyxtQ0FBVyxHQUFuQixVQUFvQixJQUFnQixFQUFFLGVBQThCLEVBQUUsVUFBa0IsRUFBRSxRQUF3QixFQUFFLEtBQVUsRUFBRSxLQUFvQjtRQUFwSixpQkF1QkM7UUF0QkcsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENB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LENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNYLHNCQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3hCLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hDLENBQUM7UUFDRCxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFDTCxvQkFBQztBQUFELENBdkRBLEFBdURDLElBQUE7QUF2REQ7K0JBdURDLENBQUEiLCJmaWxlIjoibGliL21vZHVsZS9Nb2R1bGVzTG9hZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gXCJibHVlYmlyZFwiO1xuaW1wb3J0ICogYXMgVHlwZXMgZnJvbSBcIi4uLy4uL2NvbXBvbmVudHMvdHlwZXMvVHlwZXNcIjtcbmltcG9ydCBNb2R1bGVMaXN0IGZyb20gXCIuL01vZHVsZUxpc3RcIjtcbmltcG9ydCBEZXBlbmRhbnRNb2R1bGUgZnJvbSBcIi4vRGVwZW5kYW50TW9kdWxlXCI7XG5pbXBvcnQgU3RhdGljTG9nZ2VyIGZyb20gXCIuLi8uLi9jb21wb25lbnRzL2xvZ3MvU3RhdGljTG9nZ2VyXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1vZHVsZXNMb2FkZXIge1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcGFja2FnZUpzb246IHN0cmluZywgcHJpdmF0ZSBtb2R1bGVOYW1lSW5QYWNrYWdlSnNvbjogc3RyaW5nLFxuICAgICAgICBwcml2YXRlIG1vZHVsZUFwcEZpbGVOYW1lSW5QYWNrYWdlSnNvbjogc3RyaW5nLFxuICAgICAgICBwcml2YXRlIG1vZHVsZURlcGVuZGVuY2llc0luUGFja2FnZUpzb246IHN0cmluZykge31cblxuICAgIGxvYWRNb2R1bGUobGlzdDogTW9kdWxlTGlzdCwgZGlzYWJsZWRNb2R1bGVzOiBBcnJheTxzdHJpbmc+LCBtb2R1bGVCYXNlOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgZGVmZXJyZWQgPSBQcm9taXNlLmRlZmVyKCk7XG4gICAgICAgIGZzLnJlYWRkaXIocGF0aC5qb2luKHByb2Nlc3MuY3dkKCksIG1vZHVsZUJhc2UpLCB0aGlzLnByb2Nlc3NEaXJzLmJpbmQodGhpcywgbGlzdCwgZGlzYWJsZWRNb2R1bGVzLCBtb2R1bGVCYXNlLCBkZWZlcnJlZCkpO1xuICAgICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHByb2Nlc3NEaXJzKGxpc3Q6IE1vZHVsZUxpc3QsIGRpc2FibGVkTW9kdWxlczogQXJyYXk8c3RyaW5nPiwgbW9kdWxlQmFzZTogc3RyaW5nLCBkZWZlcnJlZDogVHlwZXMuUmVzb2x2ZXIsIGVycm9yOiBhbnksIGZpbGVzOiBBcnJheTxzdHJpbmc+KTogdm9pZCB7XG4gICAgICAgIGlmICghZXJyb3IgJiYgZmlsZXMgJiYgZmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZm9yIChsZXQgaSBpbiBkaXNhYmxlZE1vZHVsZXMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmRleDogbnVtYmVyID0gZmlsZXMuaW5kZXhPZihpKTtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7IGNvbnRpbnVlOyB9XG4gICAgICAgICAgICAgICAgZmlsZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBwcm9taXNlczogQXJyYXk8UHJvbWlzZTxhbnk+PiA9IFtdO1xuICAgICAgICAgICAgZmlsZXMuZm9yRWFjaCgoZmlsZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGVmZXJyZWQgPSBQcm9taXNlLmRlZmVyKCk7XG4gICAgICAgICAgICAgICAgZnMucmVhZEZpbGUocGF0aC5qb2luKHByb2Nlc3MuY3dkKCksIG1vZHVsZUJhc2UsIGZpbGUsIHRoaXMucGFja2FnZUpzb24pLCB0aGlzLnByb2Nlc3NQYWNha2dlSnNvbkZpbGUuYmluZCh0aGlzLCBsaXN0LCBtb2R1bGVCYXNlLCBmaWxlLCBkZWZlcnJlZCkpO1xuICAgICAgICAgICAgICAgIHByb21pc2VzLnB1c2goZGVmZXJyZWQucHJvbWlzZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoZXJyb3IgJiYgZXJyb3IuY29kZSAhPT0gXCJFTk9FTlRcIikge1xuICAgICAgICAgICAgICAgIFN0YXRpY0xvZ2dlci5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVycmVkLnJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcm9jZXNzUGFjYWtnZUpzb25GaWxlKGxpc3Q6IE1vZHVsZUxpc3QsIG1vZHVsZUJhc2U6IHN0cmluZywgZmlsZTogc3RyaW5nLCBkZWZlcnJlZDogVHlwZXMuUmVzb2x2ZXIsIGVycm9yOiBhbnksIGZpbGVEYXRhOiBhbnkpIHtcbiAgICAgICAgaWYgKGVycm9yIHx8ICFmaWxlRGF0YSkgeyByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZSgpOyB9XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgZGF0YSA9IEpTT04ucGFyc2UoZmlsZURhdGEpO1xuICAgICAgICAgICAgaWYgKGRhdGFbdGhpcy5tb2R1bGVOYW1lSW5QYWNrYWdlSnNvbl0pIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtb2R1bGVBcHBGaWxlID0gZGF0YVt0aGlzLm1vZHVsZUFwcEZpbGVOYW1lSW5QYWNrYWdlSnNvbl07XG4gICAgICAgICAgICAgICAgY29uc3QgZGVwZW5kYW50TW9kdWxlOiBEZXBlbmRhbnRNb2R1bGUgPSBsaXN0LmNyZWF0ZU1vZHVsZShkYXRhLm5hbWUsIGRhdGEudmVyc2lvbiwgcGF0aC5qb2luKG1vZHVsZUJhc2UsIGZpbGUpLCBtb2R1bGVBcHBGaWxlKTtcbiAgICAgICAgICAgICAgICBjb25zdCBkZXBlbmRlbmNpZXMgPSBkYXRhW3RoaXMubW9kdWxlRGVwZW5kZW5jaWVzSW5QYWNrYWdlSnNvbl07XG4gICAgICAgICAgICAgICAgaWYgKGRlcGVuZGVuY2llcykge1xuICAgICAgICAgICAgICAgICAgICBkZXBlbmRhbnRNb2R1bGUuY2xvbmVEZXBlbmRlbmNpZXMoZGVwZW5kZW5jaWVzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGlzdC5hZGQoZGVwZW5kYW50TW9kdWxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBTdGF0aWNMb2dnZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgIHJldHVybiBkZWZlcnJlZC5yZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZGVmZXJyZWQucmVzb2x2ZSgpO1xuICAgIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
