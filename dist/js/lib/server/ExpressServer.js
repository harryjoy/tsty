"use strict";
var express = require("express");
var http = require("http");
var https = require("https");
var fs = require("fs");
var passport = require("passport");
var cookieParser = require("cookie-parser");
var expressJwt = require("express-jwt");
var methodOverride = require("method-override");
var errorHandler = require("errorhandler");
var ModuleNames_1 = require("../config/ModuleNames");
var ExpressConfigManager_1 = require("./express/ExpressConfigManager");
var ExpressServer = (function () {
    function ExpressServer() {
        this.name = "express";
    }
    ExpressServer.prototype.destroy = function () {
        this.app = null;
        this.database = null;
        this.application = null;
    };
    ExpressServer.prototype.start = function (application, database) {
        var _this = this;
        this.application = application;
        this.database = database.connection;
        this.app = express();
        var config = this.application.config;
        this.configureExpress(config);
        this.configureHttpServers(config);
        this.application.register(ModuleNames_1.default.EXPRESS_APP_MODULE, function () {
            return _this.app;
        });
        this.application.app = this.app;
        var configs = ExpressConfigManager_1.default.getConfigs();
        if (configs && configs.length > 0) {
            configs.forEach(function (config) {
                config.configure(_this.app);
            });
        }
    };
    ExpressServer.prototype.afterStartup = function (cb) {
        var _this = this;
        this.app.get(this.application.config.url.framework, function (req, res) {
            res.status(200).send(_this.application.config.framework);
        });
        this.app.route("*").get(function (req, res, next) {
            res.status(404).send({
                url: req.originalUrl,
                error: "Not Found"
            });
        });
        if (process.env.NODE_ENV === "development") {
            this.app.use(errorHandler());
        }
        if (cb) {
            cb(this);
        }
    };
    ExpressServer.prototype.configureHttpServers = function (config) {
        var httpServer = http.createServer(this.app);
        this.application.register(ModuleNames_1.default.HTTP_MODULE, httpServer);
        httpServer.listen(config.http.port);
        if (config.https && config.https.port
            && config.https.key
            && config.https.ca
            && config.https.cert) {
            var options = {
                key: fs.readFileSync(config.https.key),
                ca: fs.readFileSync(config.https.ca),
                cert: fs.readFileSync(config.https.cert)
            };
            var httpsServer = https.createServer(options, this.app);
            this.application.register(ModuleNames_1.default.HTTPS_MODULE, httpsServer);
            httpServer.listen(config.https.port);
        }
        return httpServer;
    };
    ExpressServer.prototype.configureExpress = function (config) {
        this.app.use(function (req, res, next) {
            res.setHeader("X-Powered-By", config.framework.name);
            next();
        });
        this.app.use(cookieParser());
        this.app.use(methodOverride());
        this.app.use("/api", expressJwt({
            secret: config.secret,
            credentialsRequired: config.credentialsRequired
        }), function (req, res, next) {
            if (req.user) {
                req.user = JSON.parse(decodeURI(req.user));
            }
            next();
        });
        this.addPassportSupport();
    };
    ExpressServer.prototype.addPassportSupport = function () {
        this.app.use(passport.initialize());
        this.app.use(passport.session());
        this.application.register(ModuleNames_1.default.PASSPORT_MODULE, passport);
    };
    return ExpressServer;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = ExpressServer;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zZXJ2ZXIvRXhwcmVzc1NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsSUFBWSxPQUFPLFdBQU0sU0FBUyxDQUFDLENBQUE7QUFDbkMsSUFBWSxJQUFJLFdBQU0sTUFBTSxDQUFDLENBQUE7QUFDN0IsSUFBWSxLQUFLLFdBQU0sT0FBTyxDQUFDLENBQUE7QUFDL0IsSUFBWSxFQUFFLFdBQU0sSUFBSSxDQUFDLENBQUE7QUFDekIsSUFBWSxRQUFRLFdBQU0sVUFBVSxDQUFDLENBQUE7QUFDckMsSUFBWSxZQUFZLFdBQU0sZUFBZSxDQUFDLENBQUE7QUFDOUMsSUFBWSxVQUFVLFdBQU0sYUFBYSxDQUFDLENBQUE7QUFDMUMsSUFBWSxjQUFjLFdBQU0saUJBQWlCLENBQUMsQ0FBQTtBQUNsRCxJQUFZLFlBQVksV0FBTSxjQUFjLENBQUMsQ0FBQTtBQUU3Qyw0QkFBd0IsdUJBQXVCLENBQUMsQ0FBQTtBQUNoRCxxQ0FBaUMsZ0NBQWdDLENBQUMsQ0FBQTtBQU1sRTtJQUFBO1FBQ0ksU0FBSSxHQUFXLFNBQVMsQ0FBQztJQW1HN0IsQ0FBQztJQTlGRywrQkFBTyxHQUFQO1FBQ0ksSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7SUFDNUIsQ0FBQztJQUVELDZCQUFLLEdBQUwsVUFBTSxXQUE4QixFQUFFLFFBQTJCO1FBQWpFLGlCQW9CQztRQW5CRyxJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUMvQixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUM7UUFDcEMsSUFBSSxDQUFDLEdBQUcsR0FBRyxPQUFPLEVBQUUsQ0FBQztRQUVyQixJQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQztRQUN2QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDOUIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRWxDLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLHFCQUFXLENBQUMsa0JBQWtCLEVBQUU7WUFDdEQsTUFBTSxDQUFDLEtBQUksQ0FBQyxHQUFHLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBRWhDLElBQUksT0FBTyxHQUEwQiw4QkFBb0IsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUN2RSxFQUFFLENBQUMsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBQyxNQUFNO2dCQUNuQixNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMvQixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUM7SUFDTCxDQUFDO0lBRUQsb0NBQVksR0FBWixVQUFhLEVBQWE7UUFBMUIsaUJBZ0JDO1FBZkcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxVQUFDLEdBQW9CLEVBQUUsR0FBcUI7WUFDNUYsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDNUQsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQyxHQUFvQixFQUFFLEdBQXFCLEVBQUUsSUFBMEI7WUFDNUYsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ2pCLEdBQUcsRUFBRSxHQUFHLENBQUMsV0FBVztnQkFDcEIsS0FBSyxFQUFFLFdBQVc7YUFDckIsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQ3pDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7UUFDakMsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFBQyxDQUFDO0lBQ3pCLENBQUM7SUFFTyw0Q0FBb0IsR0FBNUIsVUFBNkIsTUFBZTtRQUN4QyxJQUFJLFVBQVUsR0FBZ0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMscUJBQVcsQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDL0QsVUFBVSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXBDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJO2VBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRztlQUNoQixNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUU7ZUFDZixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDM0IsSUFBTSxPQUFPLEdBQUc7Z0JBQ1osR0FBRyxFQUFFLEVBQUUsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7Z0JBQ3RDLEVBQUUsRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUNwQyxJQUFJLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQzthQUMzQyxDQUFDO1lBQ0YsSUFBSSxXQUFXLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3hELElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLHFCQUFXLENBQUMsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDO1lBQ2pFLFVBQVUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QyxDQUFDO1FBRUQsTUFBTSxDQUFDLFVBQVUsQ0FBQztJQUN0QixDQUFDO0lBRU8sd0NBQWdCLEdBQXhCLFVBQXlCLE1BQWU7UUFDcEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBQyxHQUFvQixFQUFFLEdBQXFCLEVBQUUsSUFBMEI7WUFDakYsR0FBRyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyRCxJQUFJLEVBQUUsQ0FBQztRQUNYLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUM7WUFDNUIsTUFBTSxFQUFFLE1BQU0sQ0FBQyxNQUFNO1lBQ3JCLG1CQUFtQixFQUFFLE1BQU0sQ0FBQyxtQkFBbUI7U0FDbEQsQ0FBQyxFQUFFLFVBQUMsR0FBb0IsRUFBRSxHQUFxQixFQUFFLElBQTBCO1lBQ3hFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNYLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDL0MsQ0FBQztZQUNELElBQUksRUFBRSxDQUFDO1FBQ1gsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBRU8sMENBQWtCLEdBQTFCO1FBQ0ksSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMscUJBQVcsQ0FBQyxlQUFlLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDckUsQ0FBQztJQUNMLG9CQUFDO0FBQUQsQ0FwR0EsQUFvR0MsSUFBQTtBQXBHRDsrQkFvR0MsQ0FBQSIsImZpbGUiOiJsaWIvc2VydmVyL0V4cHJlc3NTZXJ2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBleHByZXNzIGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XG5pbXBvcnQgKiBhcyBodHRwcyBmcm9tIFwiaHR0cHNcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0ICogYXMgcGFzc3BvcnQgZnJvbSBcInBhc3Nwb3J0XCI7XG5pbXBvcnQgKiBhcyBjb29raWVQYXJzZXIgZnJvbSBcImNvb2tpZS1wYXJzZXJcIjtcbmltcG9ydCAqIGFzIGV4cHJlc3NKd3QgZnJvbSBcImV4cHJlc3Mtand0XCI7XG5pbXBvcnQgKiBhcyBtZXRob2RPdmVycmlkZSBmcm9tIFwibWV0aG9kLW92ZXJyaWRlXCI7XG5pbXBvcnQgKiBhcyBlcnJvckhhbmRsZXIgZnJvbSBcImVycm9yaGFuZGxlclwiO1xuaW1wb3J0ICogYXMgVHlwZXMgZnJvbSBcIi4uLy4uL2NvbXBvbmVudHMvdHlwZXMvVHlwZXNcIjtcbmltcG9ydCBNb2R1bGVOYW1lcyBmcm9tIFwiLi4vY29uZmlnL01vZHVsZU5hbWVzXCI7XG5pbXBvcnQgRXhwcmVzc0NvbmZpZ01hbmFnZXIgZnJvbSBcIi4vZXhwcmVzcy9FeHByZXNzQ29uZmlnTWFuYWdlclwiO1xuaW1wb3J0IHsgSUNvbmZpZyB9IGZyb20gXCIuLi9jb25maWcvSUNvbmZpZ1wiO1xuaW1wb3J0IHsgSUV4cHJlc3NDb25maWcgfSBmcm9tIFwiLi9leHByZXNzL0lFeHByZXNzQ29uZmlnXCI7XG5pbXBvcnQgeyBBcHBEYXRhYmFzZSB9IGZyb20gXCIuLi8uLi9jb21wb25lbnRzL2RhdGFiYXNlL0RhdGFiYXNlXCI7XG5pbXBvcnQgeyBJU2VydmVyRW5naW5lIH0gZnJvbSBcIi4vSVNlcnZlckVuZ2luZVwiO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBFeHByZXNzU2VydmVyIGltcGxlbWVudHMgSVNlcnZlckVuZ2luZSB7XG4gICAgbmFtZTogc3RyaW5nID0gXCJleHByZXNzXCI7XG4gICAgYXBwbGljYXRpb246IFR5cGVzLkFwcGxpY2F0aW9uO1xuICAgIGFwcDogZXhwcmVzcy5FeHByZXNzO1xuICAgIGRhdGFiYXNlOiBUeXBlcy5BcHBEYXRhYmFzZTtcblxuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuYXBwID0gbnVsbDtcbiAgICAgICAgdGhpcy5kYXRhYmFzZSA9IG51bGw7XG4gICAgICAgIHRoaXMuYXBwbGljYXRpb24gPSBudWxsO1xuICAgIH1cblxuICAgIHN0YXJ0KGFwcGxpY2F0aW9uOiBUeXBlcy5BcHBsaWNhdGlvbiwgZGF0YWJhc2U6IFR5cGVzLkFwcERhdGFiYXNlKSB7XG4gICAgICAgIHRoaXMuYXBwbGljYXRpb24gPSBhcHBsaWNhdGlvbjtcbiAgICAgICAgdGhpcy5kYXRhYmFzZSA9IGRhdGFiYXNlLmNvbm5lY3Rpb247XG4gICAgICAgIHRoaXMuYXBwID0gZXhwcmVzcygpO1xuXG4gICAgICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMuYXBwbGljYXRpb24uY29uZmlnO1xuICAgICAgICB0aGlzLmNvbmZpZ3VyZUV4cHJlc3MoY29uZmlnKTtcbiAgICAgICAgdGhpcy5jb25maWd1cmVIdHRwU2VydmVycyhjb25maWcpO1xuXG4gICAgICAgIHRoaXMuYXBwbGljYXRpb24ucmVnaXN0ZXIoTW9kdWxlTmFtZXMuRVhQUkVTU19BUFBfTU9EVUxFLCAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hcHA7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmFwcGxpY2F0aW9uLmFwcCA9IHRoaXMuYXBwO1xuXG4gICAgICAgIGxldCBjb25maWdzOiBBcnJheTxJRXhwcmVzc0NvbmZpZz4gPSBFeHByZXNzQ29uZmlnTWFuYWdlci5nZXRDb25maWdzKCk7XG4gICAgICAgIGlmIChjb25maWdzICYmIGNvbmZpZ3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uZmlncy5mb3JFYWNoKChjb25maWcpID0+IHtcbiAgICAgICAgICAgICAgICBjb25maWcuY29uZmlndXJlKHRoaXMuYXBwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYWZ0ZXJTdGFydHVwKGNiPzogRnVuY3Rpb24pIHtcbiAgICAgICAgdGhpcy5hcHAuZ2V0KHRoaXMuYXBwbGljYXRpb24uY29uZmlnLnVybC5mcmFtZXdvcmssIChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICByZXMuc3RhdHVzKDIwMCkuc2VuZCh0aGlzLmFwcGxpY2F0aW9uLmNvbmZpZy5mcmFtZXdvcmspO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmFwcC5yb3V0ZShcIipcIikuZ2V0KChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlLCBuZXh0OiBleHByZXNzLk5leHRGdW5jdGlvbikgPT4ge1xuICAgICAgICAgICAgcmVzLnN0YXR1cyg0MDQpLnNlbmQoe1xuICAgICAgICAgICAgICAgIHVybDogcmVxLm9yaWdpbmFsVXJsLFxuICAgICAgICAgICAgICAgIGVycm9yOiBcIk5vdCBGb3VuZFwiXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSBcImRldmVsb3BtZW50XCIpIHtcbiAgICAgICAgICAgIHRoaXMuYXBwLnVzZShlcnJvckhhbmRsZXIoKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNiKSB7IGNiKHRoaXMpOyB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb25maWd1cmVIdHRwU2VydmVycyhjb25maWc6IElDb25maWcpIHtcbiAgICAgICAgbGV0IGh0dHBTZXJ2ZXI6IGh0dHAuU2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIodGhpcy5hcHApO1xuICAgICAgICB0aGlzLmFwcGxpY2F0aW9uLnJlZ2lzdGVyKE1vZHVsZU5hbWVzLkhUVFBfTU9EVUxFLCBodHRwU2VydmVyKTtcbiAgICAgICAgaHR0cFNlcnZlci5saXN0ZW4oY29uZmlnLmh0dHAucG9ydCk7XG5cbiAgICAgICAgaWYgKGNvbmZpZy5odHRwcyAmJiBjb25maWcuaHR0cHMucG9ydFxuICAgICAgICAgICAgICAgICYmIGNvbmZpZy5odHRwcy5rZXlcbiAgICAgICAgICAgICAgICAmJiBjb25maWcuaHR0cHMuY2FcbiAgICAgICAgICAgICAgICAmJiBjb25maWcuaHR0cHMuY2VydCkge1xuICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBrZXk6IGZzLnJlYWRGaWxlU3luYyhjb25maWcuaHR0cHMua2V5KSxcbiAgICAgICAgICAgICAgICBjYTogZnMucmVhZEZpbGVTeW5jKGNvbmZpZy5odHRwcy5jYSksXG4gICAgICAgICAgICAgICAgY2VydDogZnMucmVhZEZpbGVTeW5jKGNvbmZpZy5odHRwcy5jZXJ0KVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGxldCBodHRwc1NlcnZlciA9IGh0dHBzLmNyZWF0ZVNlcnZlcihvcHRpb25zLCB0aGlzLmFwcCk7XG4gICAgICAgICAgICB0aGlzLmFwcGxpY2F0aW9uLnJlZ2lzdGVyKE1vZHVsZU5hbWVzLkhUVFBTX01PRFVMRSwgaHR0cHNTZXJ2ZXIpO1xuICAgICAgICAgICAgaHR0cFNlcnZlci5saXN0ZW4oY29uZmlnLmh0dHBzLnBvcnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGh0dHBTZXJ2ZXI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb25maWd1cmVFeHByZXNzKGNvbmZpZzogSUNvbmZpZykge1xuICAgICAgICB0aGlzLmFwcC51c2UoKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGV4cHJlc3MuTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgICAgICByZXMuc2V0SGVhZGVyKFwiWC1Qb3dlcmVkLUJ5XCIsIGNvbmZpZy5mcmFtZXdvcmsubmFtZSk7XG4gICAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuYXBwLnVzZShjb29raWVQYXJzZXIoKSk7XG4gICAgICAgIHRoaXMuYXBwLnVzZShtZXRob2RPdmVycmlkZSgpKTtcbiAgICAgICAgdGhpcy5hcHAudXNlKFwiL2FwaVwiLCBleHByZXNzSnd0KHtcbiAgICAgICAgICAgIHNlY3JldDogY29uZmlnLnNlY3JldCxcbiAgICAgICAgICAgIGNyZWRlbnRpYWxzUmVxdWlyZWQ6IGNvbmZpZy5jcmVkZW50aWFsc1JlcXVpcmVkXG4gICAgICAgIH0pLCAocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSwgbmV4dDogZXhwcmVzcy5OZXh0RnVuY3Rpb24pID0+IHtcbiAgICAgICAgICAgIGlmIChyZXEudXNlcikge1xuICAgICAgICAgICAgICAgIHJlcS51c2VyID0gSlNPTi5wYXJzZShkZWNvZGVVUkkocmVxLnVzZXIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5leHQoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5hZGRQYXNzcG9ydFN1cHBvcnQoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFkZFBhc3Nwb3J0U3VwcG9ydCgpIHtcbiAgICAgICAgdGhpcy5hcHAudXNlKHBhc3Nwb3J0LmluaXRpYWxpemUoKSk7XG4gICAgICAgIHRoaXMuYXBwLnVzZShwYXNzcG9ydC5zZXNzaW9uKCkpO1xuICAgICAgICB0aGlzLmFwcGxpY2F0aW9uLnJlZ2lzdGVyKE1vZHVsZU5hbWVzLlBBU1NQT1JUX01PRFVMRSwgcGFzc3BvcnQpO1xuICAgIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
