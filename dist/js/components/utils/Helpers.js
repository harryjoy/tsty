"use strict";
var _ = require("lodash");
var fs = require("fs");
var path = require("path");
require("./ArrayMixins");
function mapIds(documents, idProp) {
    return _.map(documents, function (d) {
        return idProp ? d[idProp] : d.id;
    });
}
exports.mapIds = mapIds;
function mergeObjects(source, dest) {
    _.forOwn(source, function (val, key) {
        dest["" + key] = val;
    });
    return dest;
}
exports.mergeObjects = mergeObjects;
function lowerCaseFirstLetter(text) {
    return text.charAt(0).toLowerCase() + text.slice(1);
}
exports.lowerCaseFirstLetter = lowerCaseFirstLetter;
function traverseDirectory(basePath, excludeDirs, cb) {
    var jsFileRegex = /(.*).js/;
    if (fs.existsSync(basePath)) {
        fs.readdirSync(basePath).forEach(function (file) {
            var filePath = path.join(basePath, file);
            var fstat = fs.statSync(filePath);
            if (fstat.isFile() && jsFileRegex.test(file)) {
                cb(filePath);
            }
            else if (fstat.isDirectory() && excludeDirs.indexOf(file) === -1) {
                traverseDirectory(filePath, excludeDirs, cb);
            }
        });
    }
}
exports.traverseDirectory = traverseDirectory;
function diffDocs(last, current, idProp) {
    idProp = idProp || "id";
    return {
        updated: diffObj(current, last, idProp),
        deleted: mapIds(diffObj(last, current, function () {
            return true;
        }, idProp), idProp)
    };
}
exports.diffDocs = diffDocs;
function diffObj(array, values, cb, sortProp) {
    if (typeof cb === "string") {
        sortProp = cb;
        cb = null;
    }
    if (sortProp) {
        return _.reduce(array, function (memo, item) {
            var value, idx;
            while (memo.lastIndex < values.length) {
                value = values[memo.lastIndex];
                if (value[sortProp] < item[sortProp]) {
                    memo.lastIndex++;
                    continue;
                }
                break;
            }
            idx = memo.lastIndex;
            while (idx < values.length) {
                if (value[sortProp] > item[sortProp]) {
                    break;
                }
                if (_.isEqualWith(value, item, cb)) {
                    return memo;
                }
                value = values[++idx];
            }
            memo.diff.push(item);
            return memo;
        }, {
            diff: [],
            lastIndex: 0
        }).diff;
    }
    return _.reduce(array, function (memo, item) {
        if (!_.find(values, function (value) {
            return _.isEqualWith(value, item, cb);
        })) {
            memo.push(item);
        }
        return memo;
    }, []);
}
exports.diffObj = diffObj;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvdXRpbHMvSGVscGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDNUIsSUFBWSxFQUFFLFdBQU0sSUFBSSxDQUFDLENBQUE7QUFDekIsSUFBWSxJQUFJLFdBQU0sTUFBTSxDQUFDLENBQUE7QUFDN0IsUUFBTyxlQUFlLENBQUMsQ0FBQTtBQUt2QixnQkFBdUIsU0FBYyxFQUFFLE1BQWU7SUFDbEQsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFVBQUMsQ0FBTTtRQUMzQixNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ3JDLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUplLGNBQU0sU0FJckIsQ0FBQTtBQUtELHNCQUE2QixNQUFXLEVBQUUsSUFBUztJQUMvQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxVQUFDLEdBQVEsRUFBRSxHQUFRO1FBQ2hDLElBQUksQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO0lBQ3pCLENBQUMsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxDQUFDLElBQUksQ0FBQztBQUNoQixDQUFDO0FBTGUsb0JBQVksZUFLM0IsQ0FBQTtBQUtELDhCQUFxQyxJQUFZO0lBQzdDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDeEQsQ0FBQztBQUZlLDRCQUFvQix1QkFFbkMsQ0FBQTtBQU1ELDJCQUFrQyxRQUFnQixFQUFFLFdBQW1CLEVBQUUsRUFBWTtJQUNqRixJQUFNLFdBQVcsR0FBSSxTQUFTLENBQUM7SUFDL0IsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFR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TUFBTSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDMUIsQ0FBQztZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3JCLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDaEIsQ0FBQyxFQUFFO1lBQ0MsSUFBSSxFQUFFLEVBQUU7WUFDUixTQUFTLEVBQUUsQ0FBQztTQUNmLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDWixDQUFDO0lBQ0QsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLFVBQUMsSUFBUyxFQUFFLElBQVM7UUFDeEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxVQUFDLEtBQVU7WUFDM0IsTUFBTSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMxQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BCLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNYLENBQUM7QUF6Q2UsZUFBTyxVQXlDdEIsQ0FBQSIsImZpbGUiOiJjb21wb25lbnRzL3V0aWxzL0hlbHBlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBfIGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IFwiLi9BcnJheU1peGluc1wiO1xuXG4vKipcbiAqIENvbnZlcnQgYXJyYXkgb2YgZG9jdW1lbnRzIHRvIGEgYXJyYXkgb2YgaWRzIGZyb20gdGhhdCBkb2N1bWVudHMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtYXBJZHMoZG9jdW1lbnRzOiBhbnksIGlkUHJvcD86IHN0cmluZykge1xuICAgIHJldHVybiBfLm1hcChkb2N1bWVudHMsIChkOiBhbnkpID0+IHtcbiAgICAgICAgcmV0dXJuIGlkUHJvcCA/IGRbaWRQcm9wXSA6IGQuaWQ7XG4gICAgfSk7XG59XG5cbi8qKlxuICogTWVyZ2UgdHdvIG9iamVjdHMsIHNpbXBseSBvdmVycmlkZXMgYWxsIHNvdXJjZSBwcm9wZXJ0aWVzIGludG8gZGVzdGluYXRpb24uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtZXJnZU9iamVjdHMoc291cmNlOiBhbnksIGRlc3Q6IGFueSkge1xuICAgIF8uZm9yT3duKHNvdXJjZSwgKHZhbDogYW55LCBrZXk6IGFueSkgPT4ge1xuICAgICAgICBkZXN0W1wiXCIgKyBrZXldID0gdmFsO1xuICAgIH0pO1xuICAgIHJldHVybiBkZXN0O1xufVxuXG4vKipcbiAqIExvd2VyIGNhc2UgZmlyc3QgbGV0dGVyIG9mIHN0cmluZ1xuICovXG5leHBvcnQgZnVuY3Rpb24gbG93ZXJDYXNlRmlyc3RMZXR0ZXIodGV4dDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGV4dC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSArIHRleHQuc2xpY2UoMSk7XG59XG5cbi8qKlxuICogUmVjdXJzaXZlbHkgdHJhdmVyc2UgcGF0aCBhbmQgZXhlY3V0ZSBjYWxsYmFja3MgZm9yIGVhY2ggZmlsZSBmb3VuZC5cbiAqIENhbGxiYWNrIHdpbGwgaGF2ZSBmaWxlIHBhdGggd2l0aCBiYXNlUGF0aCBpbmNsdWRlZCBpbiBpdCBhcyBhcmd1bWVudC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRyYXZlcnNlRGlyZWN0b3J5KGJhc2VQYXRoOiBzdHJpbmcsIGV4Y2x1ZGVEaXJzOiBzdHJpbmcsIGNiOiBGdW5jdGlvbikge1xuICAgIGNvbnN0IGpzRmlsZVJlZ2V4ICA9IC8oLiopLmpzLztcbiAgICBpZiAoZnMuZXhpc3RzU3luYyhiYXNlUGF0aCkpIHtcbiAgICAgICAgZnMucmVhZGRpclN5bmMoYmFzZVBhdGgpLmZvckVhY2goKGZpbGUpID0+IHtcbiAgICAgICAgICAgIGxldCBmaWxlUGF0aCA9IHBhdGguam9pbihiYXNlUGF0aCwgZmlsZSk7XG4gICAgICAgICAgICBsZXQgZnN0YXQgPSBmcy5zdGF0U3luYyhmaWxlUGF0aCk7XG4gICAgICAgICAgICBpZiAoZnN0YXQuaXNGaWxlKCkgJiYganNGaWxlUmVnZXgudGVzdChmaWxlKSkge1xuICAgICAgICAgICAgICAgIGNiKGZpbGVQYXRoKVxuICAgICAgICAgICAgfSBlbHNlIGlmIChmc3RhdC5pc0RpcmVjdG9yeSgpICYmIGV4Y2x1ZGVEaXJzLmluZGV4T2YoZmlsZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgdHJhdmVyc2VEaXJlY3RvcnkoZmlsZVBhdGgsIGV4Y2x1ZGVEaXJzLCBjYik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuLyoqXG4gKiBGaW5kIGRpZmZlcmVudCBiZXR3ZWVuIDIgZG9jdW1lbnRzLlxuICogQHBhcmFtIHthbnl9IGxhc3QgICAgXG4gKiBAcGFyYW0ge2FueX0gY3VycmVudCBcbiAqIEBwYXJhbSB7c3RyaW5nfSAgICAgaWRQcm9wICBQb3BlcnR5IG5hbWUgaG9sZGluZyBJRC9rZXkgdG8gaWRlbnRpZnkgZG9jdW1lbnQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBkaWZmRG9jcyhsYXN0OiBhbnksIGN1cnJlbnQ6IGFueSwgaWRQcm9wPzogc3RyaW5nKSB7XG4gICAgaWRQcm9wID0gaWRQcm9wIHx8IFwiaWRcIjtcbiAgICByZXR1cm4ge1xuICAgICAgICB1cGRhdGVkOiBkaWZmT2JqKGN1cnJlbnQsIGxhc3QsIGlkUHJvcCksXG4gICAgICAgIGRlbGV0ZWQ6IG1hcElkcyhkaWZmT2JqKGxhc3QsIGN1cnJlbnQsICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9LCBpZFByb3ApLCBpZFByb3ApXG4gICAgfTtcbn1cblxuLyoqXG4gKiBkaWZmT2JqIC0gc2ltaWxhciB0byBfLmRpZmZlcmVuY2UsIGV4Y2VwdCB1c2VzIF8uaXNFcXVhbCB0byBkZWVwIGNvbXBhcmUgb2JqZWN0cyBpbiBhcnJheXNcbiAqIEBwYXJhbSBhcnJheSAtIEFycmF5OiBhcnJheSBvZiBvYmplY3RzXG4gKiBAcGFyYW0gdmFsdWVzIC0gQXJyYXk6IGFycmF5IG9mIG9iamVjdHMgdG8gc3VidHJhY3RcbiAqIEBwYXJhbSBjYWxsYmFjayAtIEZ1bmN0aW9uIHwgU3RyaW5nOiBvcHRpb25hbCBpc0VxdWFsIGNvbXBhcmlzb24gY2FsbGJhY2suXG4gKiAgICAgICAgICAgICAgICAgICBGb3Igc29ydGVkIGFycmF5cywgc29ydCBwcm9wZXJ0eSBpcyBpbXBsaWN0bHkgY29tcGFyZWQgZmlyc3QuXG4gKiBAcGFyYW0gc29ydFByb3AgLSBTdHJpbmc6IG9wdGlvbmFsIHBhcmFtZXRlciBzcGVjaWZpZXMgaXRlbXMgYXJlIHNvcnRlZCBieSBjb3JyZXNwb25kaW5nXG4gKiAgICAgICAgICAgICAgICAgICBwcmltaXRpdmUgcHJvcGVydHkgKG11c3QgYmUgc29ydGVkIGluIGFzY2VuZGluZyBvcmRlcilcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRpZmZPYmooYXJyYXk6IGFueSwgdmFsdWVzOiBhbnksIGNiOiBhbnksIHNvcnRQcm9wPzogYW55KSB7XG4gICAgaWYgKHR5cGVvZiBjYiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICBzb3J0UHJvcCA9IGNiO1xuICAgICAgICBjYiA9IG51bGw7XG4gICAgfVxuICAgIGlmIChzb3J0UHJvcCkge1xuICAgICAgICByZXR1cm4gXy5yZWR1Y2UoYXJyYXksIChtZW1vOiBhbnksIGl0ZW06IGFueSkgPT4ge1xuICAgICAgICAgICAgbGV0IHZhbHVlLCBpZHg6IG51bWJlcjtcbiAgICAgICAgICAgIHdoaWxlKG1lbW8ubGFzdEluZGV4IDwgdmFsdWVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVzW21lbW8ubGFzdEluZGV4XTtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWVbc29ydFByb3BdIDwgaXRlbVtzb3J0UHJvcF0pIHtcbiAgICAgICAgICAgICAgICAgICAgbWVtby5sYXN0SW5kZXgrKztcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWR4ID0gbWVtby5sYXN0SW5kZXg7XG4gICAgICAgICAgICB3aGlsZShpZHggPCB2YWx1ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlW3NvcnRQcm9wXSA+IGl0ZW1bc29ydFByb3BdKSB7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoXy5pc0VxdWFsV2l0aCh2YWx1ZSwgaXRlbSwgY2IpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBtZW1vO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlc1srK2lkeF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtZW1vLmRpZmYucHVzaChpdGVtKTtcbiAgICAgICAgICAgIHJldHVybiBtZW1vO1xuICAgICAgICB9LCB7XG4gICAgICAgICAgICBkaWZmOiBbXSxcbiAgICAgICAgICAgIGxhc3RJbmRleDogMFxuICAgICAgICB9KS5kaWZmO1xuICAgIH1cbiAgICByZXR1cm4gXy5yZWR1Y2UoYXJyYXksIChtZW1vOiBhbnksIGl0ZW06IGFueSkgPT4ge1xuICAgICAgICBpZiAoIV8uZmluZCh2YWx1ZXMsICh2YWx1ZTogYW55KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gXy5pc0VxdWFsV2l0aCh2YWx1ZSwgaXRlbSwgY2IpO1xuICAgICAgICB9KSkge1xuICAgICAgICAgICAgbWVtby5wdXNoKGl0ZW0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtZW1vO1xuICAgIH0sIFtdKTtcbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
