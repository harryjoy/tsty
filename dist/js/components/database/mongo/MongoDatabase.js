"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var mongoose = require("mongoose");
var Promise = require("bluebird");
var _ = require("lodash");
var Logger_1 = require("../../logs/Logger");
var Constants_1 = require("../Constants");
var ModuleConfig_1 = require("../../../lib/module/ModuleConfig");
var ModuleNames_1 = require("../../../lib/config/ModuleNames");
var Database_1 = require("../Database");
var index_1 = require("../../../index");
var MongoDatabase = (function (_super) {
    __extends(MongoDatabase, _super);
    function MongoDatabase(url, prefix, options) {
        _super.call(this, url, prefix, options);
        mongoose.set("debug", options && options.mongoose && options.mongoose.debug);
        this.connectionPool = {};
    }
    MongoDatabase.prototype.connect = function () {
        var defer = Promise.defer();
        this.openNewConnection(this.url, this.options)
            .then(this.onDefaultConnectionOpen.bind(this, defer))
            .catch(function (err) {
            defer.reject(err);
        });
        return defer.promise;
    };
    MongoDatabase.prototype.disconnect = function () {
        var _this = this;
        var defer = Promise.defer();
        if (!this.isConnected()) {
            Logger_1.default.info("No connection is opened to close.");
            return;
        }
        this.connection.close();
        this.connection.once("disconnect", function () {
            _this.reset();
            defer.resolve({
                disconnected: true
            });
        });
        this.connection.once("error", function (err) {
            defer.reject(err);
        });
        return defer.promise;
    };
    MongoDatabase.prototype.isConnected = function () {
        return this.getConnectionReadyState() === Constants_1.default.connStats["CONNECTED"];
    };
    MongoDatabase.prototype.listen = function (name, cb) {
        this.connection.on(name, cb);
    };
    MongoDatabase.prototype.updateModelStructure = function (model) {
        model.fields = _.merge({}, model.fields);
        model.methods = _.merge({}, model.methods);
        model.statics = _.merge({}, model.statics);
    };
    MongoDatabase.prototype.bindModelListeners = function (model, listeners) {
    };
    MongoDatabase.prototype.registerModel = function (modelData) {
        var found = this.isModelExistInModels(modelData.name);
        if (found) {
            return;
        }
        var schema = modelData.schema;
        var colllection = modelData.collection;
        if (this.prefix) {
            colllection = this.prefix + "_" + colllection;
        }
        var dbModels = [];
        for (var _i = 0, _a = modelData.dbs; _i < _a.length; _i++) {
            var db = _a[_i];
            dbModels.push(this.createDbModel(db, modelData.name, schema, colllection));
        }
        return dbModels;
    };
    MongoDatabase.prototype.getConnectionReadyState = function () {
        return this.connection.readyState;
    };
    MongoDatabase.prototype.onDefaultConnectionOpen = function (defer, result) {
        this.connection = result.connection;
        index_1.application.register(ModuleNames_1.default.DATABASE_MODULE, this);
        var config = index_1.application.config;
        var promises = [];
        if (config.dbOptions.dbs && config.dbOptions.dbs.length > 0) {
            for (var i in config.dbOptions.dbs) {
                promises.push(this.openNewConnection(config.dbOptions.dbs[i], _.merge(this.options || {}, {
                    alias: i
                })));
            }
        }
        Promise.all(promises).then(this.databaseReady.bind(this, defer));
    };
    MongoDatabase.prototype.databaseReady = function (defer, connectionPool) {
        for (var _i = 0, connectionPool_1 = connectionPool; _i < connectionPool_1.length; _i++) {
            var conn = connectionPool_1[_i];
            if (conn.state !== "fulfilled") {
                continue;
            }
            this.connectionPool[conn.value.alias] = conn.value.connection;
        }
        defer.resolve();
    };
    MongoDatabase.prototype.openNewConnection = function (url, options) {
        var defer = Promise.defer();
        var connection = mongoose.createConnection(url, options);
        connection.once("connected", function () {
            defer.resolve({
                uri: url,
                alias: options.alias,
                connection: connection
            });
        });
        connection.once("error", function (err) {
            defer.reject(err);
        });
        return defer.promise;
    };
    MongoDatabase.prototype.createDbModel = function (alias, name, schema, colllection) {
        var model;
        if (colllection) {
            model = this.getMongoConnectionByAlias(alias).model(name, schema, colllection);
        }
        else {
            model = this.getMongoConnectionByAlias(alias).model(name, schema);
        }
        return model;
    };
    MongoDatabase.prototype.getMongoConnectionByAlias = function (alias) {
        if (alias === ModuleConfig_1.default.DEFAULT_DB_NAME || !this.connectionPool[alias]) {
            return this.connection;
        }
        return this.connectionPool[alias];
    };
    MongoDatabase.prototype.isConnectionOpenForAlias = function (alias) {
        return (alias === ModuleConfig_1.default.DEFAULT_DB_NAME) || !!this.connectionPool[alias];
    };
    return MongoDatabase;
}(Database_1.AppDatabase));
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = MongoDatabase;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvZGF0YWJhc2UvbW9uZ28vTW9uZ29EYXRhYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFZLFFBQVEsV0FBTSxVQUFVLENBQUMsQ0FBQTtBQUNyQyxJQUFZLE9BQU8sV0FBTSxVQUFVLENBQUMsQ0FBQTtBQUNwQyxJQUFZLENBQUMsV0FBTSxRQUFRLENBQUMsQ0FBQTtBQUU1Qix1QkFBbUIsbUJBQW1CLENBQUMsQ0FBQTtBQUN2QywwQkFBc0IsY0FBYyxDQUFDLENBQUE7QUFDckMsNkJBQXlCLGtDQUFrQyxDQUFDLENBQUE7QUFDNUQsNEJBQXdCLGlDQUFpQyxDQUFDLENBQUE7QUFFMUQseUJBQTRCLGFBQWEsQ0FBQyxDQUFBO0FBQzFDLHNCQUE0QixnQkFBZ0IsQ0FBQyxDQUFBO0FBYTdDO0lBQTJDLGlDQUFpRTtJQUd4Ryx1QkFBWSxHQUFXLEVBQUUsTUFBYyxFQUFFLE9BQVE7UUFDN0Msa0JBQU0sR0FBRyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM1QixRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxPQUFPLElBQUksT0FBTyxDQUFDLFFBQVEsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdFLElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFRCwrQkFBTyxHQUFQO1FBQ0ksSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUM7YUFDekMsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQ3BELEtBQUssQ0FBQyxVQUFDLEdBQUc7WUFDUCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFD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LElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQU0sSUFBSSxFQUFFLE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQztRQUN4RixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixLQUFLLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBTSxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDM0UsQ0FBQztRQUNELE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVPLGlEQUF5QixHQUFqQyxVQUFrQyxLQUFhO1FBQzNDLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxzQkFBWSxDQUFDLGVBQWUsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3hFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQzNCLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRU8sZ0RBQXdCLEdBQWhDLFVBQWlDLEtBQWE7UUFDMUMsTUFBTSxDQUFDLENBQUMsS0FBSyxLQUFLLHNCQUFZLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEYsQ0FBQztJQUNMLG9CQUFDO0FBQUQsQ0F4SUEsQUF3SUMsQ0F4STBDLHNCQUFXLEdBd0lyRDtBQXhJRDsrQkF3SUMsQ0FBQSIsImZpbGUiOiJjb21wb25lbnRzL2RhdGFiYXNlL21vbmdvL01vbmdvRGF0YWJhc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBtb25nb29zZSBmcm9tIFwibW9uZ29vc2VcIjtcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCI7XG5pbXBvcnQgKiBhcyBfIGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCAqIGFzIFR5cGVzIGZyb20gXCIuLi8uLi90eXBlcy9UeXBlc1wiO1xuaW1wb3J0IExvZ2dlciBmcm9tIFwiLi4vLi4vbG9ncy9Mb2dnZXJcIjtcbmltcG9ydCBDb25zdGFudHMgZnJvbSBcIi4uL0NvbnN0YW50c1wiO1xuaW1wb3J0IE1vZHVsZUNvbmZpZyBmcm9tIFwiLi4vLi4vLi4vbGliL21vZHVsZS9Nb2R1bGVDb25maWdcIjtcbmltcG9ydCBNb2R1bGVOYW1lcyBmcm9tIFwiLi4vLi4vLi4vbGliL2NvbmZpZy9Nb2R1bGVOYW1lc1wiO1xuaW1wb3J0IHsgTW9uZ29Nb2RlbCB9IGZyb20gXCIuL01vbmdvTW9kZWxcIjtcbmltcG9ydCB7IEFwcERhdGFiYXNlIH0gZnJvbSBcIi4uL0RhdGFiYXNlXCI7XG5pbXBvcnQgeyBhcHBsaWNhdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9pbmRleFwiO1xuXG5pbnRlcmZhY2UgSUNvbm5lY3Rpb25SZXNvbHZlciB7XG4gICAgdXJpOiBzdHJpbmc7XG4gICAgY29ubmVjdGlvbjogbW9uZ29vc2UuQ29ubmVjdGlvbjtcbiAgICBhbGlhcz86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIElDb25uZWN0aW9uUG9vbEVudGl0eSB7XG4gICAgc3RhdGU6IHN0cmluZztcbiAgICB2YWx1ZTogSUNvbm5lY3Rpb25SZXNvbHZlclxufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNb25nb0RhdGFiYXNlIGV4dGVuZHMgQXBwRGF0YWJhc2U8bW9uZ29vc2UuQ29ubmVjdGlvbiwgTW9uZ29Nb2RlbCwgbW9uZ29vc2UuTW9kZWw8YW55Pj4ge1xuICAgIHByaXZhdGUgY29ubmVjdGlvblBvb2w6IFR5cGVzLk1hcDtcblxuICAgIGNvbnN0cnVjdG9yKHVybDogc3RyaW5nLCBwcmVmaXg6IHN0cmluZywgb3B0aW9ucz8pIHtcbiAgICAgICAgc3VwZXIodXJsLCBwcmVmaXgsIG9wdGlvbnMpO1xuICAgICAgICBtb25nb29zZS5zZXQoXCJkZWJ1Z1wiLCBvcHRpb25zICYmIG9wdGlvbnMubW9uZ29vc2UgJiYgb3B0aW9ucy5tb25nb29zZS5kZWJ1Zyk7XG4gICAgICAgIHRoaXMuY29ubmVjdGlvblBvb2wgPSB7fTtcbiAgICB9XG5cbiAgICBjb25uZWN0KCk6IFByb21pc2U8e30+IHtcbiAgICAgICAgY29uc3QgZGVmZXIgPSBQcm9taXNlLmRlZmVyKCk7XG4gICAgICAgIHRoaXMub3Blbk5ld0Nvbm5lY3Rpb24odGhpcy51cmwsIHRoaXMub3B0aW9ucylcbiAgICAgICAgICAgIC50aGVuKHRoaXMub25EZWZhdWx0Q29ubmVjdGlvbk9wZW4uYmluZCh0aGlzLCBkZWZlcikpXG4gICAgICAgICAgICAuY2F0Y2goKGVycik9PiB7XG4gICAgICAgICAgICAgICAgZGVmZXIucmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7XG4gICAgfVxuXG4gICAgZGlzY29ubmVjdCgpOiBQcm9taXNlPHt9PiB7XG4gICAgICAgIGNvbnN0IGRlZmVyID0gUHJvbWlzZS5kZWZlcigpO1xuICAgICAgICBpZiAoIXRoaXMuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgICAgICAgTG9nZ2VyLmluZm8oXCJObyBjb25uZWN0aW9uIGlzIG9wZW5lZCB0byBjbG9zZS5cIik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jb25uZWN0aW9uLmNsb3NlKCk7XG4gICAgICAgIHRoaXMuY29ubmVjdGlvbi5vbmNlKFwiZGlzY29ubmVjdFwiLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlc2V0KCk7XG4gICAgICAgICAgICBkZWZlci5yZXNvbHZlKHtcbiAgICAgICAgICAgICAgICBkaXNjb25uZWN0ZWQ6IHRydWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uLm9uY2UoXCJlcnJvclwiLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICBkZWZlci5yZWplY3QoZXJyKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlO1xuICAgIH1cblxuICAgIGlzQ29ubmVjdGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRDb25uZWN0aW9uUmVhZHlTdGF0ZSgpID09PSBDb25zdGFudHMuY29ublN0YXRzW1wiQ09OTkVDVEVEXCJdO1xuICAgIH1cblxuICAgIGxpc3RlbihuYW1lOiBzdHJpbmcsIGNiOiBGdW5jdGlvbikge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub24obmFtZSwgY2IpO1xuICAgIH1cblxuICAgIHVwZGF0ZU1vZGVsU3RydWN0dXJlKG1vZGVsOiBNb25nb01vZGVsKSB7XG4gICAgICAgIG1vZGVsLmZpZWxkcyA9IF8ubWVyZ2Uoe30sIG1vZGVsLmZpZWxkcyk7XG4gICAgICAgIG1vZGVsLm1ldGhvZHMgPSBfLm1lcmdlKHt9LCBtb2RlbC5tZXRob2RzKTtcbiAgICAgICAgbW9kZWwuc3RhdGljcyA9IF8ubWVyZ2Uoe30sIG1vZGVsLnN0YXRpY3MpO1xuICAgIH1cblxuICAgIGJpbmRNb2RlbExpc3RlbmVycyhtb2RlbDogTW9uZ29Nb2RlbCwgbGlzdGVuZXJzOiBBcnJheTxUeXBlcy5MaXN0ZW5lcj4pIHtcbiAgICB9XG5cbiAgICByZWdpc3Rlck1vZGVsKG1vZGVsRGF0YTogTW9uZ29Nb2RlbCk6IEFycmF5PG1vbmdvb3NlLk1vZGVsPGFueT4+IHtcbiAgICAgICAgY29uc3QgZm91bmQgPSB0aGlzLmlzTW9kZWxFeGlzdEluTW9kZWxzKG1vZGVsRGF0YS5uYW1lKTtcbiAgICAgICAgaWYgKGZvdW5kKSB7IHJldHVybjsgfVxuICAgICAgICBjb25zdCBzY2hlbWEgPSBtb2RlbERhdGEuc2NoZW1hO1xuICAgICAgICBsZXQgY29sbGxlY3Rpb24gPSBtb2RlbERhdGEuY29sbGVjdGlvbjtcbiAgICAgICAgaWYgKHRoaXMucHJlZml4KSB7XG4gICAgICAgICAgICBjb2xsbGVjdGlvbiA9IHRoaXMucHJlZml4ICsgXCJfXCIgKyBjb2xsbGVjdGlvbjtcbiAgICAgICAgfVxuICAgICAgICBsZXQgZGJNb2RlbHM6IEFycmF5PG1vbmdvb3NlLk1vZGVsPGFueT4+ID0gW107XG4gICAgICAgIGZvciAobGV0IGRiIG9mIG1vZGVsRGF0YS5kYnMpIHtcbiAgICAgICAgICAgIGRiTW9kZWxzLnB1c2godGhpcy5jcmVhdGVEYk1vZGVsKGRiLCBtb2RlbERhdGEubmFtZSwgc2NoZW1hLCBjb2xsbGVjdGlvbikpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkYk1vZGVscztcbiAgICB9XG5cbiAgICBnZXRDb25uZWN0aW9uUmVhZHlTdGF0ZSgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uLnJlYWR5U3RhdGU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkRlZmF1bHRDb25uZWN0aW9uT3BlbihkZWZlcjogUHJvbWlzZS5SZXNvbHZlcjx7fT4sIHJlc3VsdDogSUNvbm5lY3Rpb25SZXNvbHZlcikge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24gPSByZXN1bHQuY29ubmVjdGlvbjtcbiAgICAgICAgYXBwbGljYXRpb24ucmVnaXN0ZXIoTW9kdWxlTmFtZXMuREFUQUJBU0VfTU9EVUxFLCB0aGlzKTtcblxuICAgICAgICBsZXQgY29uZmlnID0gYXBwbGljYXRpb24uY29uZmlnO1xuICAgICAgICBsZXQgcHJvbWlzZXMgPSBbXTtcbiAgICAgICAgaWYgKGNvbmZpZy5kYk9wdGlvbnMuZGJzICYmIGNvbmZpZy5kYk9wdGlvbnMuZGJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gY29uZmlnLmRiT3B0aW9ucy5kYnMpIHtcbiAgICAgICAgICAgICAgICBwcm9taXNlcy5wdXNoKHRoaXMub3Blbk5ld0Nvbm5lY3Rpb24oY29uZmlnLmRiT3B0aW9ucy5kYnNbaV0sIF8ubWVyZ2UodGhpcy5vcHRpb25zIHx8IHt9LCB7XG4gICAgICAgICAgICAgICAgICAgIGFsaWFzOiBpXG4gICAgICAgICAgICAgICAgfSkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbih0aGlzLmRhdGFiYXNlUmVhZHkuYmluZCh0aGlzLCBkZWZlcikpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGF0YWJhc2VSZWFkeShkZWZlcjogUHJvbWlzZS5SZXNvbHZlcjx7fT4sIGNvbm5lY3Rpb25Qb29sOiBBcnJheTxJQ29ubmVjdGlvblBvb2xFbnRpdHk+KSB7XG4gICAgICAgIGZvciAobGV0IGNvbm4gb2YgY29ubmVjdGlvblBvb2wpIHtcbiAgICAgICAgICAgIGlmIChjb25uLnN0YXRlICE9PSBcImZ1bGZpbGxlZFwiKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb25Qb29sW2Nvbm4udmFsdWUuYWxpYXNdID0gY29ubi52YWx1ZS5jb25uZWN0aW9uO1xuICAgICAgICB9XG4gICAgICAgIGRlZmVyLnJlc29sdmUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9wZW5OZXdDb25uZWN0aW9uKHVybDogc3RyaW5nLCBvcHRpb25zPyk6IFByb21pc2U8SUNvbm5lY3Rpb25SZXNvbHZlciB8IHt9PiB7XG4gICAgICAgIGNvbnN0IGRlZmVyID0gUHJvbWlzZS5kZWZlcigpO1xuICAgICAgICBsZXQgY29ubmVjdGlvbiA9IG1vbmdvb3NlLmNyZWF0ZUNvbm5lY3Rpb24odXJsLCBvcHRpb25zKTtcbiAgICAgICAgY29ubmVjdGlvbi5vbmNlKFwiY29ubmVjdGVkXCIsICgpID0+IHtcbiAgICAgICAgICAgIGRlZmVyLnJlc29sdmUoe1xuICAgICAgICAgICAgICAgIHVyaTogdXJsLFxuICAgICAgICAgICAgICAgIGFsaWFzOiBvcHRpb25zLmFsaWFzLFxuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb246IGNvbm5lY3Rpb25cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgY29ubmVjdGlvbi5vbmNlKFwiZXJyb3JcIiwgKGVycikgPT4ge1xuICAgICAgICAgICAgZGVmZXIucmVqZWN0KGVycik7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZURiTW9kZWwoYWxpYXM6IHN0cmluZywgbmFtZTogc3RyaW5nLCBzY2hlbWE6IG1vbmdvb3NlLlNjaGVtYSwgY29sbGxlY3Rpb246IHN0cmluZyk6IG1vbmdvb3NlLk1vZGVsPGFueT4ge1xuICAgICAgICBsZXQgbW9kZWw6IG1vbmdvb3NlLk1vZGVsPGFueT47XG4gICAgICAgIGlmIChjb2xsbGVjdGlvbikge1xuICAgICAgICAgICAgbW9kZWwgPSB0aGlzLmdldE1vbmdvQ29ubmVjdGlvbkJ5QWxpYXMoYWxpYXMpLm1vZGVsPGFueT4obmFtZSwgc2NoZW1hLCBjb2xsbGVjdGlvbik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtb2RlbCA9IHRoaXMuZ2V0TW9uZ29Db25uZWN0aW9uQnlBbGlhcyhhbGlhcykubW9kZWw8YW55PihuYW1lLCBzY2hlbWEpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtb2RlbDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldE1vbmdvQ29ubmVjdGlvbkJ5QWxpYXMoYWxpYXM6IHN0cmluZyk6IG1vbmdvb3NlLkNvbm5lY3Rpb24ge1xuICAgICAgICBpZiAoYWxpYXMgPT09IE1vZHVsZUNvbmZpZy5ERUZBVUxUX0RCX05BTUUgfHwgIXRoaXMuY29ubmVjdGlvblBvb2xbYWxpYXNdKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb25Qb29sW2FsaWFzXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzQ29ubmVjdGlvbk9wZW5Gb3JBbGlhcyhhbGlhczogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoYWxpYXMgPT09IE1vZHVsZUNvbmZpZy5ERUZBVUxUX0RCX05BTUUpIHx8ICEhdGhpcy5jb25uZWN0aW9uUG9vbFthbGlhc107XG4gICAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
