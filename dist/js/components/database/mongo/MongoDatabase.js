"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var mongoose = require("mongoose");
var Promise = require("bluebird");
var _ = require("lodash");
var Logger_1 = require("../../logs/Logger");
var Constants_1 = require("../Constants");
var ModuleConfig_1 = require("../../../lib/module/ModuleConfig");
var Database_1 = require("../Database");
var index_1 = require("../../../index");
var MongoDatabase = (function (_super) {
    __extends(MongoDatabase, _super);
    function MongoDatabase(url, prefix, options) {
        _super.call(this, url, prefix, options);
        mongoose.set("debug", options && options.mongoose && options.mongoose.debug);
        this.connectionPool = {};
    }
    MongoDatabase.prototype.connect = function () {
        var defer = Promise.defer();
        this.openNewConnection(this.url, this.options)
            .then(this.onDefaultConnectionOpen.bind(this, defer))
            .catch(function (err) {
            defer.reject(err);
        });
        return defer.promise;
    };
    MongoDatabase.prototype.disconnect = function () {
        var _this = this;
        var defer = Promise.defer();
        if (!this.isConnected()) {
            Logger_1.default.info("No connection is opened to close.");
            return;
        }
        this.connection.close();
        this.connection.once("disconnect", function () {
            _this.reset();
            defer.resolve({
                disconnected: true
            });
        });
        this.connection.once("error", function (err) {
            defer.reject(err);
        });
        return defer.promise;
    };
    MongoDatabase.prototype.isConnected = function () {
        return this.getConnectionReadyState() === Constants_1.default.connStats["CONNECTED"];
    };
    MongoDatabase.prototype.listen = function (name, cb) {
        this.connection.on(name, cb);
    };
    MongoDatabase.prototype.updateModelStructure = function (model) {
        model.fields = _.merge({}, model.fields);
        model.methods = _.merge({}, model.methods);
        model.statics = _.merge({}, model.statics);
    };
    MongoDatabase.prototype.bindModelListeners = function (model, listeners) {
    };
    MongoDatabase.prototype.registerModel = function (modelData) {
        var found = this.isModelExistInModels(modelData.name);
        if (found) {
            return;
        }
        var schema = modelData.schema;
        var colllection = modelData.collection;
        if (this.prefix) {
            colllection = this.prefix + "_" + colllection;
        }
        var dbModels = [];
        for (var _i = 0, _a = modelData.dbs; _i < _a.length; _i++) {
            var db = _a[_i];
            dbModels.push(this.createDbModel(db, modelData.name, schema, colllection));
        }
        return dbModels;
    };
    MongoDatabase.prototype.getConnectionReadyState = function () {
        return this.connection.readyState;
    };
    MongoDatabase.prototype.onDefaultConnectionOpen = function (defer, result) {
        this.connection = result.connection;
        var config = index_1.application.config;
        var promises = [];
        if (config.dbOptions.dbs && config.dbOptions.dbs.length > 0) {
            for (var i in config.dbOptions.dbs) {
                promises.push(this.openNewConnection(config.dbOptions.dbs[i], _.merge(this.options || {}, {
                    alias: i
                })));
            }
        }
        Promise.all(promises).then(this.databaseReady.bind(this, defer));
    };
    MongoDatabase.prototype.databaseReady = function (defer, connectionPool) {
        for (var _i = 0, connectionPool_1 = connectionPool; _i < connectionPool_1.length; _i++) {
            var conn = connectionPool_1[_i];
            if (conn.state !== "fulfilled") {
                continue;
            }
            this.connectionPool[conn.value.alias] = conn.value.connection;
        }
        defer.resolve();
    };
    MongoDatabase.prototype.openNewConnection = function (url, options) {
        var defer = Promise.defer();
        var connection = mongoose.createConnection(url, options);
        connection.once("connected", function () {
            defer.resolve({
                uri: url,
                alias: options.alias,
                connection: connection
            });
        });
        connection.once("error", function (err) {
            defer.reject(err);
        });
        return defer.promise;
    };
    MongoDatabase.prototype.createDbModel = function (alias, name, schema, colllection) {
        var model;
        if (colllection) {
            model = this.getMongoConnectionByAlias(alias).model(name, schema, colllection);
        }
        else {
            model = this.getMongoConnectionByAlias(alias).model(name, schema);
        }
        return model;
    };
    MongoDatabase.prototype.getMongoConnectionByAlias = function (alias) {
        if (alias === ModuleConfig_1.default.DEFAULT_DB_NAME || !this.connectionPool[alias]) {
            return this.connection;
        }
        return this.connectionPool[alias];
    };
    MongoDatabase.prototype.isConnectionOpenForAlias = function (alias) {
        return (alias === ModuleConfig_1.default.DEFAULT_DB_NAME) || !!this.connectionPool[alias];
    };
    return MongoDatabase;
}(Database_1.AppDatabase));
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = MongoDatabase;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvZGF0YWJhc2UvbW9uZ28vTW9uZ29EYXRhYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFZLFFBQVEsV0FBTSxVQUFVLENBQUMsQ0FBQTtBQUNyQyxJQUFZLE9BQU8sV0FBTSxVQUFVLENBQUMsQ0FBQTtBQUNwQyxJQUFZLENBQUMsV0FBTSxRQUFRLENBQUMsQ0FBQTtBQUU1Qix1QkFBbUIsbUJBQW1CLENBQUMsQ0FBQTtBQUN2QywwQkFBc0IsY0FBYyxDQUFDLENBQUE7QUFDckMsNkJBQXlCLGtDQUFrQyxDQUFDLENBQUE7QUFFNUQseUJBQTRCLGFBQWEsQ0FBQyxDQUFBO0FBQzFDLHNCQUE0QixnQkFBZ0IsQ0FBQyxDQUFBO0FBYTdDO0lBQTJDLGlDQUFpRTtJQUd4Ryx1QkFBWSxHQUFXLEVBQUUsTUFBYyxFQUFFLE9BQVE7UUFDN0Msa0JBQU0sR0FBRyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM1QixRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxPQUFPLElBQUksT0FBTyxDQUFDLFFBQVEsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdFLElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFRCwrQkFBTyxHQUFQO1FBQ0ksSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUM7YUFDekMsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQ3BELEtBQUssQ0FBQyxVQUFDLEdBQUc7WUFDUCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsTUFB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O1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixLQUFLLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBTSxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDM0UsQ0FBQztRQUNELE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVPLGlEQUF5QixHQUFqQyxVQUFrQyxLQUFhO1FBQzNDLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxzQkFBWSxDQUFDLGVBQWUsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3hFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQzNCLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRU8sZ0RBQXdCLEdBQWhDLFVBQWlDLEtBQWE7UUFDMUMsTUFBTSxDQUFDLENBQUMsS0FBSyxLQUFLLHNCQUFZLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEYsQ0FBQztJQUNMLG9CQUFDO0FBQUQsQ0F2SUEsQUF1SUMsQ0F2STBDLHNCQUFXLEdBdUlyRDtBQXZJRDsrQkF1SUMsQ0FBQSIsImZpbGUiOiJjb21wb25lbnRzL2RhdGFiYXNlL21vbmdvL01vbmdvRGF0YWJhc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBtb25nb29zZSBmcm9tIFwibW9uZ29vc2VcIjtcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCI7XG5pbXBvcnQgKiBhcyBfIGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCAqIGFzIFR5cGVzIGZyb20gXCIuLi8uLi90eXBlcy9UeXBlc1wiO1xuaW1wb3J0IExvZ2dlciBmcm9tIFwiLi4vLi4vbG9ncy9Mb2dnZXJcIjtcbmltcG9ydCBDb25zdGFudHMgZnJvbSBcIi4uL0NvbnN0YW50c1wiO1xuaW1wb3J0IE1vZHVsZUNvbmZpZyBmcm9tIFwiLi4vLi4vLi4vbGliL21vZHVsZS9Nb2R1bGVDb25maWdcIjtcbmltcG9ydCB7IE1vbmdvTW9kZWwgfSBmcm9tIFwiLi9Nb25nb01vZGVsXCI7XG5pbXBvcnQgeyBBcHBEYXRhYmFzZSB9IGZyb20gXCIuLi9EYXRhYmFzZVwiO1xuaW1wb3J0IHsgYXBwbGljYXRpb24gfSBmcm9tIFwiLi4vLi4vLi4vaW5kZXhcIjtcblxuaW50ZXJmYWNlIElDb25uZWN0aW9uUmVzb2x2ZXIge1xuICAgIHVyaTogc3RyaW5nO1xuICAgIGNvbm5lY3Rpb246IG1vbmdvb3NlLkNvbm5lY3Rpb247XG4gICAgYWxpYXM/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJQ29ubmVjdGlvblBvb2xFbnRpdHkge1xuICAgIHN0YXRlOiBzdHJpbmc7XG4gICAgdmFsdWU6IElDb25uZWN0aW9uUmVzb2x2ZXJcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTW9uZ29EYXRhYmFzZSBleHRlbmRzIEFwcERhdGFiYXNlPG1vbmdvb3NlLkNvbm5lY3Rpb24sIE1vbmdvTW9kZWwsIG1vbmdvb3NlLk1vZGVsPGFueT4+IHtcbiAgICBwcml2YXRlIGNvbm5lY3Rpb25Qb29sOiBUeXBlcy5NYXA7XG5cbiAgICBjb25zdHJ1Y3Rvcih1cmw6IHN0cmluZywgcHJlZml4OiBzdHJpbmcsIG9wdGlvbnM/KSB7XG4gICAgICAgIHN1cGVyKHVybCwgcHJlZml4LCBvcHRpb25zKTtcbiAgICAgICAgbW9uZ29vc2Uuc2V0KFwiZGVidWdcIiwgb3B0aW9ucyAmJiBvcHRpb25zLm1vbmdvb3NlICYmIG9wdGlvbnMubW9uZ29vc2UuZGVidWcpO1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb25Qb29sID0ge307XG4gICAgfVxuXG4gICAgY29ubmVjdCgpOiBQcm9taXNlPHt9PiB7XG4gICAgICAgIGNvbnN0IGRlZmVyID0gUHJvbWlzZS5kZWZlcigpO1xuICAgICAgICB0aGlzLm9wZW5OZXdDb25uZWN0aW9uKHRoaXMudXJsLCB0aGlzLm9wdGlvbnMpXG4gICAgICAgICAgICAudGhlbih0aGlzLm9uRGVmYXVsdENvbm5lY3Rpb25PcGVuLmJpbmQodGhpcywgZGVmZXIpKVxuICAgICAgICAgICAgLmNhdGNoKChlcnIpPT4ge1xuICAgICAgICAgICAgICAgIGRlZmVyLnJlamVjdChlcnIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlO1xuICAgIH1cblxuICAgIGRpc2Nvbm5lY3QoKTogUHJvbWlzZTx7fT4ge1xuICAgICAgICBjb25zdCBkZWZlciA9IFByb21pc2UuZGVmZXIoKTtcbiAgICAgICAgaWYgKCF0aGlzLmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgICAgICAgIExvZ2dlci5pbmZvKFwiTm8gY29ubmVjdGlvbiBpcyBvcGVuZWQgdG8gY2xvc2UuXCIpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY29ubmVjdGlvbi5jbG9zZSgpO1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub25jZShcImRpc2Nvbm5lY3RcIiwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXNldCgpO1xuICAgICAgICAgICAgZGVmZXIucmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgZGlzY29ubmVjdGVkOiB0cnVlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY29ubmVjdGlvbi5vbmNlKFwiZXJyb3JcIiwgKGVycikgPT4ge1xuICAgICAgICAgICAgZGVmZXIucmVqZWN0KGVycik7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZGVmZXIucHJvbWlzZTtcbiAgICB9XG5cbiAgICBpc0Nvbm5lY3RlZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29ubmVjdGlvblJlYWR5U3RhdGUoKSA9PT0gQ29uc3RhbnRzLmNvbm5TdGF0c1tcIkNPTk5FQ1RFRFwiXTtcbiAgICB9XG5cbiAgICBsaXN0ZW4obmFtZTogc3RyaW5nLCBjYjogRnVuY3Rpb24pIHtcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uLm9uKG5hbWUsIGNiKTtcbiAgICB9XG5cbiAgICB1cGRhdGVNb2RlbFN0cnVjdHVyZShtb2RlbDogTW9uZ29Nb2RlbCkge1xuICAgICAgICBtb2RlbC5maWVsZHMgPSBfLm1lcmdlKHt9LCBtb2RlbC5maWVsZHMpO1xuICAgICAgICBtb2RlbC5tZXRob2RzID0gXy5tZXJnZSh7fSwgbW9kZWwubWV0aG9kcyk7XG4gICAgICAgIG1vZGVsLnN0YXRpY3MgPSBfLm1lcmdlKHt9LCBtb2RlbC5zdGF0aWNzKTtcbiAgICB9XG5cbiAgICBiaW5kTW9kZWxMaXN0ZW5lcnMobW9kZWw6IE1vbmdvTW9kZWwsIGxpc3RlbmVyczogQXJyYXk8VHlwZXMuTGlzdGVuZXI+KSB7XG4gICAgfVxuXG4gICAgcmVnaXN0ZXJNb2RlbChtb2RlbERhdGE6IE1vbmdvTW9kZWwpOiBBcnJheTxtb25nb29zZS5Nb2RlbDxhbnk+PiB7XG4gICAgICAgIGNvbnN0IGZvdW5kID0gdGhpcy5pc01vZGVsRXhpc3RJbk1vZGVscyhtb2RlbERhdGEubmFtZSk7XG4gICAgICAgIGlmIChmb3VuZCkgeyByZXR1cm47IH1cbiAgICAgICAgY29uc3Qgc2NoZW1hID0gbW9kZWxEYXRhLnNjaGVtYTtcbiAgICAgICAgbGV0IGNvbGxsZWN0aW9uID0gbW9kZWxEYXRhLmNvbGxlY3Rpb247XG4gICAgICAgIGlmICh0aGlzLnByZWZpeCkge1xuICAgICAgICAgICAgY29sbGxlY3Rpb24gPSB0aGlzLnByZWZpeCArIFwiX1wiICsgY29sbGxlY3Rpb247XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGRiTW9kZWxzOiBBcnJheTxtb25nb29zZS5Nb2RlbDxhbnk+PiA9IFtdO1xuICAgICAgICBmb3IgKGxldCBkYiBvZiBtb2RlbERhdGEuZGJzKSB7XG4gICAgICAgICAgICBkYk1vZGVscy5wdXNoKHRoaXMuY3JlYXRlRGJNb2RlbChkYiwgbW9kZWxEYXRhLm5hbWUsIHNjaGVtYSwgY29sbGxlY3Rpb24pKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZGJNb2RlbHM7XG4gICAgfVxuXG4gICAgZ2V0Q29ubmVjdGlvblJlYWR5U3RhdGUoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbi5yZWFkeVN0YXRlO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25EZWZhdWx0Q29ubmVjdGlvbk9wZW4oZGVmZXI6IFByb21pc2UuUmVzb2x2ZXI8e30+LCByZXN1bHQ6IElDb25uZWN0aW9uUmVzb2x2ZXIpIHtcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uID0gcmVzdWx0LmNvbm5lY3Rpb247XG5cbiAgICAgICAgbGV0IGNvbmZpZyA9IGFwcGxpY2F0aW9uLmNvbmZpZztcbiAgICAgICAgbGV0IHByb21pc2VzID0gW107XG4gICAgICAgIGlmIChjb25maWcuZGJPcHRpb25zLmRicyAmJiBjb25maWcuZGJPcHRpb25zLmRicy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpIGluIGNvbmZpZy5kYk9wdGlvbnMuZGJzKSB7XG4gICAgICAgICAgICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLm9wZW5OZXdDb25uZWN0aW9uKGNvbmZpZy5kYk9wdGlvbnMuZGJzW2ldLCBfLm1lcmdlKHRoaXMub3B0aW9ucyB8fCB7fSwge1xuICAgICAgICAgICAgICAgICAgICBhbGlhczogaVxuICAgICAgICAgICAgICAgIH0pKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4odGhpcy5kYXRhYmFzZVJlYWR5LmJpbmQodGhpcywgZGVmZXIpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRhdGFiYXNlUmVhZHkoZGVmZXI6IFByb21pc2UuUmVzb2x2ZXI8e30+LCBjb25uZWN0aW9uUG9vbDogQXJyYXk8SUNvbm5lY3Rpb25Qb29sRW50aXR5Pikge1xuICAgICAgICBmb3IgKGxldCBjb25uIG9mIGNvbm5lY3Rpb25Qb29sKSB7XG4gICAgICAgICAgICBpZiAoY29ubi5zdGF0ZSAhPT0gXCJmdWxmaWxsZWRcIikge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uUG9vbFtjb25uLnZhbHVlLmFsaWFzXSA9IGNvbm4udmFsdWUuY29ubmVjdGlvbjtcbiAgICAgICAgfVxuICAgICAgICBkZWZlci5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvcGVuTmV3Q29ubmVjdGlvbih1cmw6IHN0cmluZywgb3B0aW9ucz8pOiBQcm9taXNlPElDb25uZWN0aW9uUmVzb2x2ZXIgfCB7fT4ge1xuICAgICAgICBjb25zdCBkZWZlciA9IFByb21pc2UuZGVmZXIoKTtcbiAgICAgICAgbGV0IGNvbm5lY3Rpb24gPSBtb25nb29zZS5jcmVhdGVDb25uZWN0aW9uKHVybCwgb3B0aW9ucyk7XG4gICAgICAgIGNvbm5lY3Rpb24ub25jZShcImNvbm5lY3RlZFwiLCAoKSA9PiB7XG4gICAgICAgICAgICBkZWZlci5yZXNvbHZlKHtcbiAgICAgICAgICAgICAgICB1cmk6IHVybCxcbiAgICAgICAgICAgICAgICBhbGlhczogb3B0aW9ucy5hbGlhcyxcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uOiBjb25uZWN0aW9uXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbm5lY3Rpb24ub25jZShcImVycm9yXCIsIChlcnIpID0+IHtcbiAgICAgICAgICAgIGRlZmVyLnJlamVjdChlcnIpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVEYk1vZGVsKGFsaWFzOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgc2NoZW1hOiBtb25nb29zZS5TY2hlbWEsIGNvbGxsZWN0aW9uOiBzdHJpbmcpOiBtb25nb29zZS5Nb2RlbDxhbnk+IHtcbiAgICAgICAgbGV0IG1vZGVsOiBtb25nb29zZS5Nb2RlbDxhbnk+O1xuICAgICAgICBpZiAoY29sbGxlY3Rpb24pIHtcbiAgICAgICAgICAgIG1vZGVsID0gdGhpcy5nZXRNb25nb0Nvbm5lY3Rpb25CeUFsaWFzKGFsaWFzKS5tb2RlbDxhbnk+KG5hbWUsIHNjaGVtYSwgY29sbGxlY3Rpb24pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbW9kZWwgPSB0aGlzLmdldE1vbmdvQ29ubmVjdGlvbkJ5QWxpYXMoYWxpYXMpLm1vZGVsPGFueT4obmFtZSwgc2NoZW1hKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbW9kZWw7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRNb25nb0Nvbm5lY3Rpb25CeUFsaWFzKGFsaWFzOiBzdHJpbmcpOiBtb25nb29zZS5Db25uZWN0aW9uIHtcbiAgICAgICAgaWYgKGFsaWFzID09PSBNb2R1bGVDb25maWcuREVGQVVMVF9EQl9OQU1FIHx8ICF0aGlzLmNvbm5lY3Rpb25Qb29sW2FsaWFzXSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uUG9vbFthbGlhc107XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc0Nvbm5lY3Rpb25PcGVuRm9yQWxpYXMoYWxpYXM6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKGFsaWFzID09PSBNb2R1bGVDb25maWcuREVGQVVMVF9EQl9OQU1FKSB8fCAhIXRoaXMuY29ubmVjdGlvblBvb2xbYWxpYXNdO1xuICAgIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
